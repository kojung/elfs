{% extends "bootstrap/base.html" %}
{% block title %}
Extensible Laser Firing System
{% endblock %}

{% block styles %}
{{super()}}
<link rel="stylesheet" href="{{url_for('.static', filename='elfs.css')}}">
{% endblock %}

{% block scripts %}
{{super()}}
<script language="JavaScript">

$SCRIPT_ROOT = {{ request.script_root|tojson|safe }};

// SSE
function SSE() {
    console.log("Starting SSE")
    var eventSource = new EventSource($SCRIPT_ROOT + "/sse")
    eventSource.onmessage = function(e) {
        var state = $.parseJSON(e.data);
        // update the GUI based on server state
        $("#score").html(state.total_score);
        for (var i=0; i<4; i++) {
            var target = state.target[i];
            var targetId = "#target" + i;
            $(targetId).html(target.score);
            $(targetId).css({'background': target.color});
        }
    };
}

// stop training
function stop() {
    $.getJSON($SCRIPT_ROOT + '/stop', function(data) {
        console.log("stop: " + data.result)
    });
    stopTimer();
}

// start training
function start() {
    var params = {"mode": "practice"}
    $.getJSON($SCRIPT_ROOT + '/start', params, function(data) {
        console.log("start: " + data.result)
    });
    startTimer();
}

// adjust target height to match width
function adjustTargetHeight() {
    var cw = $('.elfs-target').width();
    $('.elfs-target').css({'height': cw+'px'});
}

function fillZero(num) {
    return num < 10 ? '0' + num : num;
};

// 10ms timer
var startTime = 0;
function updateTimer() {
    var elapsedTime = Math.floor((+new Date() - startTime) / 10);
    var mi = Math.floor(elapsedTime / (60 * 100));
    var ss = Math.floor((elapsedTime - mi * 60 * 100) / 100);
    var ms = elapsedTime - Math.floor(elapsedTime / 100) * 100;
    $('#timer').html(fillZero(mi) + ":" + fillZero(ss) + "." + fillZero(ms));
}

var timer = 0;
function startTimer() {
    startTime = +new Date();
    timer = setInterval(updateTimer, 10);
}

function stopTimer() {
    clearInterval(timer);
}

// autoload these functions
$(document).ready(SSE());
$(document).ready(adjustTargetHeight());

</script>
{% endblock %}

{% block content %}

<h1 class="text-center"><img src="static/logo.png" alt="logo" width="8%" height="auto"> Extensible Laser Firing System</h1>

<div class="row">
    <div class="col-sm-3"><div class="col-sm-12 align-middle text-center elfs-target" id="target0">0</div></div>
    <div class="col-sm-3"><div class="col-sm-12 align-middle text-center elfs-target" id="target1">0</div></div>
    <div class="col-sm-3"><div class="col-sm-12 align-middle text-center elfs-target" id="target2">0</div></div>
    <div class="col-sm-3"><div class="col-sm-12 align-middle text-center elfs-target" id="target3">0</div></div>
</div>

<ul class="nav nav-tabs">
    <li role="presentation" class="active text-center elfs-mode" id="practice-mode">
        <a href="#practice-content" data-toggle="tab">Practice</a>
    </li>
    <li role="presentation" class="text-center elfs-mode" id="timed-mode">
        <a href="#timed-content" data-toggle="tab">Timed</a>
    </li>
    <li role="presentation" class="text-center elfs-mode" id="countdown-mode">
        <a href="#countdown-content" data-toggle="tab">Countdown</a>
    </li>
</ul>

<div class="tab-content">
    <div id="practice-content" class="tab-pane fade in active elfs-mode-desc">
        Click start to practice. Click Stop to end practice.
    </div>
      
    <div id="timed-content" class="tab-pane fade in elfs-mode-desc">
        Set the a timer count down and hit as many targets as possible.
    </div>

    <div id="countdown-content" class="tab-pane fade in elfs-mode-desc">
        Each target has a count down timer.
    </div>
</div>

<div class="row">
    <div class="col-sm-4"><div class="col-sm-12 align-middle text-center">
        <div class="btn-group">
            <button type="button" class="btn btn-default elfs-button elfs-button-start" onClick="start()">Start</button>
            <button type="button" class="btn btn-default elfs-button elfs-button-stop" onClick="stop()">Stop</button>
        </div>
    </div></div>
    <div class="col-sm-4"><div class="col-sm-12 align-middle text-center elfs-timer">
        Timer<div id="timer">n/a</div>
    </div></div>
    <div class="col-sm-4"><div class="col-sm-12 align-middle text-center elfs-score">
        Score<div id="score">n/a</div>
    </div></div>
</div>

{% endblock %}

